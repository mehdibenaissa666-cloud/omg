name: Secure RDP with Tailscale

on:
  workflow_dispatch:
    inputs:
      session_duration:
        description: 'Dur√©e de la session (minutes)'
        required: true
        default: '3600'
        type: choice
        options:
          - '120'
          - '240'
          - '360'
          - '480'
          - '720'

env:
  SESSION_DURATION: ${{ github.event.inputs.session_duration }}

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ env.SESSION_DURATION }}

    steps:
      - name: V√©rifier l'environnement
        run: |
          Write-Host "üîç V√©rification de l'environnement Windows..."
          systeminfo | Select-String "OS Name", "OS Version"

      - name: Configurer RDP de mani√®re s√©curis√©e
        run: |
          Write-Host "üõ†Ô∏è Configuration de RDP..."
          
          # Activer RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # Pour la compatibilit√©, d√©sactiver NLA temporairement
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          # Configurer le pare-feu
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389 `
            description="Acc√®s RDP via Tailscale"

          # Red√©marrer les services RDP
          Get-Service -Name "TermService" | Restart-Service -Force
          Start-Service -Name "UmRdpService" -ErrorAction SilentlyContinue

          Write-Host "‚úÖ RDP configur√© avec succ√®s"

      - name: Cr√©er un utilisateur s√©curis√©
        run: |
          Write-Host "üë§ Cr√©ation de l'utilisateur RDP..."
          
          # G√©n√©rer un mot de passe robuste
          $charTypes = @{
              Majuscules = [char[]](65..90)      # A-Z
              Minuscules = [char[]](97..122)     # a-z
              Chiffres   = [char[]](48..57)      # 0-9
              Speciaux   = [char[]](33,35,36,37,38,42,43,45,61,63,64) # !#$%&*+-=?@
          }
          
          $motDePasse = @()
          foreach ($type in $charTypes.GetEnumerator()) {
              $motDePasse += $type.Value | Get-Random -Count 3
          }
          $motDePasse = -join ($motDePasse | Sort-Object { Get-Random })
          
          # Cr√©er l'utilisateur
          $securePassword = ConvertTo-SecureString $motDePasse -AsPlainText -Force
          New-LocalUser -Name "UtilisateurRDP" -Password $securePassword -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "UtilisateurRDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "UtilisateurRDP"
          
          # V√©rifier la cr√©ation
          if (Get-LocalUser -Name "UtilisateurRDP" -ErrorAction SilentlyContinue) {
              Write-Host "‚úÖ Utilisateur cr√©√© avec succ√®s"
              echo "RDP_USER=UtilisateurRDP" >> $env:GITHUB_ENV
              echo "RDP_PASSWORD=$motDePasse" >> $env:GITHUB_ENV
          } else {
              Write-Error "‚ùå √âchec de la cr√©ation de l'utilisateur"
              exit 1
          }

      - name: Installer et configurer Tailscale
        run: |
          Write-Host "üì° Installation de Tailscale..."
          
          # T√©l√©charger Tailscale
          $tailscaleURL = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale-$env:GITHUB_RUN_ID.msi"
          
          try {
              Invoke-WebRequest -Uri $tailscaleURL -OutFile $installerPath
              Write-Host "‚úÖ T√©l√©chargement r√©ussi"
          } catch {
              Write-Error "‚ùå √âchec du t√©l√©chargement de Tailscale"
              exit 1
          }

          # Installer silencieusement
          Start-Process msiexec.exe -ArgumentList @("/i", "`"$installerPath`"", "/quiet", "/norestart") -Wait
          Remove-Item $installerPath -Force

          # Attendre que le service soit install√©
          $timeout = 0
          while (-not (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") -and $timeout -lt 30) {
              Start-Sleep -Seconds 2
              $timeout++
          }

          if (Test-Path "$env:ProgramFiles\Tailscale\tailscale.exe") {
              Write-Host "‚úÖ Tailscale install√© avec succ√®s"
          } else {
              Write-Error "‚ùå √âchec de l'installation de Tailscale"
              exit 1
          }

      - name: √âtablir la connexion Tailscale
        run: |
          Write-Host "üîó Connexion √† Tailscale..."
          
          if (-not ${{ secrets.TAILSCALE_AUTH_KEY }}) {
              Write-Error "‚ùå Cl√© d'authentification Tailscale manquante"
              exit 1
          }

          # Configurer Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname="github-runner-$env:GITHUB_RUN_ID" `
            --accept-routes=false `
            --ssh=false

          # Obtenir l'IP Tailscale
          $ipTailscale = $null
          $tentatives = 0
          do {
              Start-Sleep -Seconds 3
              $ipTailscale = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              $tentatives++
              Write-Host "Tentative $tentatives/10 - IP: $ipTailscale"
          } while (-not $ipTailscale -and $tentatives -lt 10)

          if ($ipTailscale) {
              echo "TAILSCALE_IP=$ipTailscale" >> $env:GITHUB_ENV
              Write-Host "‚úÖ Connect√© √† Tailscale - IP: $ipTailscale"
          } else {
              Write-Error "‚ùå Impossible d'obtenir une IP Tailscale"
              exit 1
          }

      - name: V√©rifier l'accessibilit√© RDP
        run: |
          Write-Host "üîç V√©rification de l'accessibilit√© RDP..."
          
          # V√©rifier que le service RDP fonctionne
          $serviceRDP = Get-Service -Name "TermService"
          if ($serviceRDP.Status -ne "Running") {
              Write-Error "‚ùå Le service RDP n'est pas en cours d'ex√©cution"
              exit 1
          }

          # Tester la connectivit√©
          $testConnexion = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          
          if ($testConnexion.TcpTestSucceeded) {
              Write-Host "‚úÖ Connectivit√© RDP v√©rifi√©e sur $env:TAILSCALE_IP:3389"
          } else {
              Write-Warning "‚ö†Ô∏è La connexion TCP a √©chou√©, mais le service continue"
          }

      - name: Afficher les informations de connexion
        run: |
          $delimiteur = "=" * 60
          Write-Host ""
          Write-Host "üöÄ $delimiteur"
          Write-Host "   ACC√àS RDP S√âCURIS√â - READY"
          Write-Host "   $delimiteur"
          Write-Host "   üåê Adresse: $env:TAILSCALE_IP"
          Write-Host "   üë§ Utilisateur: $env:RDP_USER"
          Write-Host "   üîë Mot de passe: $env:RDP_PASSWORD"
          Write-Host "   ‚è±Ô∏è Dur√©e: $env:SESSION_DURATION minutes"
          Write-Host "   $delimiteur"
          Write-Host "   üìã Instructions:"
          Write-Host "   1. Ouvrez le Bureau √† distance (mstsc.exe)"
          Write-Host "   2. Entrez l'adresse: $env:TAILSCALE_IP"
          Write-Host "   3. Utilisez les identifiants ci-dessus"
          Write-Host "   4. La session se terminera automatiquement"
          Write-Host "   $delimiteur"
          Write-Host ""

      - name: Maintenir la session active
        run: |
          $debut = Get-Date
          $dureeTotale = [int]$env:SESSION_DURATION
          
          Write-Host "üïê Session RDP d√©marr√©e √†: $(Get-Date)"
          Write-Host "‚è≥ Dur√©e configur√©e: $dureeTotale minutes"
          
          while ($true) {
              $tempsEcoule = [int]((Get-Date) - $debut).TotalMinutes
              $tempsRestant = $dureeTotale - $tempsEcoule
              
              if ($tempsRestant -le 0) {
                  Write-Host "‚è∞ Session expir√©e - Arr√™t automatique"
                  break
              }
              
              # V√©rifier l'√©tat de Tailscale p√©riodiquement
              if ($tempsEcoule % 5 -eq 0) {
                  $statutTailscale = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
                  if ($statutTailscale.BackendState -eq "Running") {
                      Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚úÖ Session active - $tempsRestant minutes restantes"
                  } else {
                      Write-Warning "‚ö†Ô∏è Probl√®me de connexion Tailscale d√©tect√©"
                  }
              }
              
              Start-Sleep -Seconds 60
          }

      - name: Nettoyage final
        if: always()
        run: |
          Write-Host "üßπ Nettoyage des ressources..."
          
          # Supprimer l'utilisateur
          Remove-LocalUser -Name "UtilisateurRDP" -ErrorAction SilentlyContinue
          
          # D√©sactiver RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 1 -Force
          
          # Supprimer la r√®gle firewall
          netsh advfirewall firewall delete rule name="RDP-Tailscale" -ErrorAction SilentlyContinue
          
          # D√©connecter Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down -ErrorAction SilentlyContinue
          
          Write-Host "‚úÖ Nettoyage termin√© - Environnement s√©curis√©"
